<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ステージタイマー</title>
    <style>
        body{
            font-family: sans-serif;
            padding: 20px 20px 120px;
            background-color: #000000;
            color: #ffffff;
        }
        table{
            border-collapse: collapse;
            width: 100%;
            max-width: 860px;
        }
        th, td{
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: center;
        }
        /* 手動入力可能なセルは背景をわずかに変えて分かりやすく */
        .stage-title {
            background: #838383;
        }
        .button-row{
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 20px;
            background-color: #000000;
            border-top: 1px solid #333;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            z-index: 1000;
        }
        .button-row button{
            margin-right: 0;
        }
        button{
            padding: 10px 24px;
            font-size: 16px;
            margin-right: 12px;
            cursor: pointer;
        }
        button:disabled{
            opacity: .4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<table id="timerTable">
    <thead>
    <tr>
        <th>プレイヤー名</th>
        <th>タイム</th>
        <th>プレイヤー名</th>
        <th>タイム</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">鉄人の穴</td>
    </tr>
    <tr>
        <td contenteditable="true">エープリル</td>
        <td id="aTime0">00:00</td>
        <td contenteditable="true">リーヌァ</td>
        <td id="bTime0">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">赤の洞窟</td>
    </tr>
    <tr>
        <td contenteditable="true">mercysnow</td>
        <td id="aTime1">00:00</td>
        <td contenteditable="true">albut3</td>
        <td id="bTime1">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">花園を荒らすもの</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime2">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime2">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">コンクリート迷路（単騎待ち）</td>
    </tr>
    <tr>
        <td contenteditable="true">エープリル</td>
        <td id="aTime3">00:00</td>
        <td contenteditable="true">リーヌァ</td>
        <td id="bTime3">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">ショイグモの巣（残20匹）</td>
    </tr>
    <tr>
        <td contenteditable="true">mercysnow</td>
        <td id="aTime4">00:00</td>
        <td contenteditable="true">albut3</td>
        <td id="bTime4">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">大足の穴（奥間欠泉）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime5">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime5">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">食神のかまど（近視）</td>
    </tr>
    <tr>
        <td contenteditable="true">エープリル</td>
        <td id="aTime6">00:00</td>
        <td contenteditable="true">リーヌァ</td>
        <td id="bTime6">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">炎と水の試練場（交代禁止）</td>
    </tr>
    <tr>
        <td contenteditable="true">mercysnow</td>
        <td id="aTime7">00:00</td>
        <td contenteditable="true">albut3</td>
        <td id="bTime7">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">鼻息の洞穴（６粉砕）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime8">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime8">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">地底警備室（スプレーなし）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime9">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime9">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">さらいの洞窟（スプレーなし）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime10">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime10">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">秘密兵器実験場（スプレーなし）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime11">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime11">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">天罰の穴（スプレーなし無犠牲）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime12">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime12">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">どっすん迷路（スプレーなし無犠牲）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime13">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime13">00:00</td>
    </tr>
    <tr>
        <td colspan="4" class="stage-title" contenteditable="true">デメマダラの巣窟（スプレーなし無犠牲）</td>
    </tr>
    <tr>
        <td contenteditable="true">ごれい</td>
        <td id="aTime14">00:00</td>
        <td contenteditable="true">すぱ〜く</td>
        <td id="bTime14">00:00</td>
    </tr>
    <tr>
        <td colspan="2">チームA: <span id="aTotal">00:00</span></td>
        <td colspan="2">チームB: <span id="bTotal">00:00</span></td>
    </tr>
    </tbody>
</table>

<div class="button-row">
    <button id="btnA">Aチーム用ボタン</button>
    <button id="btnB">Bチーム用ボタン</button>
    <button id="btnPause">一時停止</button>
    <button id="btnReset">リセット</button>
</div>

<script>
    // ===== ユーティリティ =====
    /**
     * 経過ミリ秒を mm:ss あるいは h:mm:ss 形式の文字列に変換する
     * @param {number} ms
     * @returns {string}
     */
    function formatTime(ms){
        const totalSec = Math.floor(ms/1000)
        const tenth = Math.floor((ms % 1000) / 100)
        const h   = Math.floor(totalSec/3600)
        const min = Math.floor((totalSec%3600)/60)
        const sec = totalSec%60
        const pad = n => n.toString().padStart(2,'0')
        if(h>0){
            return `${h}:${pad(min)}:${pad(sec)}.${tenth}`
        }
        return `${pad(min)}:${pad(sec)}.${tenth}`
    }
    let isPaused = false

    // ===== タイマー管理クラス =====
    class TeamTimer{
        constructor(teamPrefix){
            this.prefix = teamPrefix // 'a' or 'b'
            // テーブル上に存在するステージ数を自動検出（例: aTime0〜aTime14）
            this.stageCount = document.querySelectorAll(`[id^="${this.prefix}Time"]`).length
            this.currentStage = -1 // -1 = 未開始, 0〜(stageCount-1) = ステージ番号
            this.stageStartAt = null // Date.now() で記録
            this.totalStartAt = null
            this.elapsedStages = new Array(this.stageCount).fill(0) // ms
            this.intervalId = null
            this.isFinished = false
            // ボタン要素
            this.button = document.getElementById(teamPrefix==='a' ? 'btnA' : 'btnB')
            this.button.addEventListener('click', ()=>this.handleClick())
        }

        /** ボタンが押されたときの処理 */
        handleClick(){
            // 一時停止中は何もしない
            if(isPaused) return
            // 未開始 → スタート
            if(this.currentStage === -1){
                this.startStage(0)
                return
            }
            // 進行中ステージを停止
            this.stopCurrentStage()
            // 次のステージが存在すれば開始, なければ終了
            if(this.currentStage < this.stageCount - 1){
                this.startStage(this.currentStage + 1)
            }else{
                // 全ステージ終了
                if(this.intervalId){
                    clearInterval(this.intervalId)
                    this.intervalId = null
                }
                this.isFinished = true
                this.button.disabled = true
            }
        }

        /** 特定ステージの計測を開始 */
        startStage(stageIndex){
            this.currentStage = stageIndex
            this.stageStartAt = Date.now()
            if(this.totalStartAt === null){
                this.totalStartAt = this.stageStartAt
            }
            // タイマー更新用インターバルをまだ持っていなければ設定
            if(!this.intervalId){
                this.intervalId = setInterval(()=>this.updateRunningTime(), 100)
            }
        }

        /** 現在計測中ステージを停止し、経過を保存 */
        stopCurrentStage(){
            if(this.currentStage === -1) return
            const now = Date.now()
            const diff = now - this.stageStartAt
            this.elapsedStages[this.currentStage] += diff
            this.stageStartAt = null
            // 最終表示更新
            this.updateRunningTime() // 直ちに更新
        }

        /** 一時停止 / 再開（再開時は計測中のラップから続行） */
        setPaused(paused){
            if(this.isFinished) return
            if(paused){
                // 進行中ステージがあれば、ここで経過を確定して止める
                if(this.currentStage !== -1 && this.stageStartAt !== null){
                    const now = Date.now()
                    this.elapsedStages[this.currentStage] += (now - this.stageStartAt)
                    this.stageStartAt = null
                }
                if(this.intervalId){
                    clearInterval(this.intervalId)
                    this.intervalId = null
                }
                this.updateRunningTime()
                this.button.disabled = true
                return
            }

            // 再開
            if(this.currentStage !== -1 && this.stageStartAt === null){
                this.stageStartAt = Date.now()
            }
            if(this.currentStage !== -1 && !this.intervalId){
                this.intervalId = setInterval(()=>this.updateRunningTime(), 100)
            }
            this.button.disabled = false
        }

        /** 計測状態を初期化（ラップ1からやり直し） */
        reset(){
            if(this.intervalId){
                clearInterval(this.intervalId)
                this.intervalId = null
            }
            this.currentStage = -1
            this.stageStartAt = null
            this.totalStartAt = null
            this.elapsedStages = new Array(this.stageCount).fill(0)
            this.isFinished = false
            this.button.disabled = false
            this.updateRunningTime()
        }

        /** 計測中の時間を画面へ反映 */
        updateRunningTime(){
            const now = Date.now()
            let runningTotal = 0

            // 各ステージの表示更新
            for(let i=0; i<this.stageCount; i++){
                let elapsed = this.elapsedStages[i]
                // 計測中ステージには現在差分を加算
                if(i === this.currentStage && this.stageStartAt !== null){
                    elapsed += (now - this.stageStartAt)
                }
                document.getElementById(`${this.prefix}Time${i}`).textContent = formatTime(elapsed)
                runningTotal += elapsed
            }
            // 合計タイム更新
            document.getElementById(`${this.prefix}Total`).textContent = formatTime(runningTotal)
        }
    }

    // ===== アプリ初期化 =====
    const teamA = new TeamTimer('a')
    const teamB = new TeamTimer('b')
    teamA.updateRunningTime()
    teamB.updateRunningTime()

    const btnPause = document.getElementById('btnPause')
    const btnReset = document.getElementById('btnReset')

    btnPause.addEventListener('click', ()=>{
        isPaused = !isPaused
        if(isPaused){
            teamA.setPaused(true)
            teamB.setPaused(true)
            btnPause.textContent = '再開'
        }else{
            teamA.setPaused(false)
            teamB.setPaused(false)
            btnPause.textContent = '一時停止'
        }
    })

    btnReset.addEventListener('click', ()=>{
        isPaused = false
        btnPause.textContent = '一時停止'
        teamA.reset()
        teamB.reset()
    })
</script>
</body>
</html>